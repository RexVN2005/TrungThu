const canvas=document.getElementById("starfield"),ctx=canvas.getContext("2d");let w,h,stars=[],meteors=[],animationId;const TWINKLE_SPEED=.003,METEOR_CHANCE=.01;const isMobile=window.innerWidth<=768,isTablet=window.innerWidth<=1024&&window.innerWidth>768,isLowEnd=navigator.hardwareConcurrency<=2||navigator.deviceMemory<=4,isHighEnd=navigator.hardwareConcurrency>=6&&navigator.deviceMemory>=8,aspectRatio=window.innerWidth/window.innerHeight,isPortrait=aspectRatio<1,isLandscape=aspectRatio>1.3,isSquare=aspectRatio>=0.9&&aspectRatio<=1.3;function resizeCanvas(){w=canvas.width=innerWidth,h=canvas.height=innerHeight,stars=[];let e=Math.round(w*h/(isLowEnd?5000:isMobile?(isPortrait?3000:4000):isTablet?(isLandscape?2500:3200):isHighEnd?1800:2200));for(let t=0;t<e;t++)stars.push({x:Math.random()*w,y:Math.random()*h,r:.9*Math.random()+.1,a:.8*Math.random()+.2,t:.02*Math.random()+.002})}function drawStars(){for(let e of(ctx.clearRect(0,0,w,h),stars)){e.a+=(Math.random()>.5?1:-1)*e.t,e.a=Math.max(.05,Math.min(1,e.a));let t=isLowEnd?.5:isHighEnd?.3*Math.sin(.003*Date.now()+.01*e.x)+.7:.4*Math.sin(.003*Date.now()+.01*e.x)+.6,n=e.a*t;ctx.beginPath(),ctx.globalAlpha=n;if(isHighEnd){let a=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,2*e.r);a.addColorStop(0,"#ffffff"),a.addColorStop(.5,"#ffd700"),a.addColorStop(1,"rgba(255, 255, 255, 0)"),ctx.fillStyle=a}else ctx.fillStyle="#ffffff";ctx.arc(e.x,e.y,e.r,0,2*Math.PI),ctx.fill(),isLowEnd||.1>Math.random()||(ctx.strokeStyle=`rgba(255, 255, 255, ${.5*n})`,ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(e.x-3*e.r,e.y),ctx.lineTo(e.x+3*e.r,e.y),ctx.moveTo(e.x,e.y-3*e.r),ctx.lineTo(e.x,e.y+3*e.r),ctx.stroke())}ctx.globalAlpha=1}function createMeteor(){let e=Math.random()*w,t=Math.random()*(h/3),n=10*Math.random()+6;meteors.push({x:e,y:t,vx:n+6,vy:n/2,len:120*Math.random()+100,a:1})}function drawMeteors(){for(let e=meteors.length-1;e>=0;e--){let t=meteors[e],n=t.x-t.len,a=t.y-t.len/2;ctx.strokeStyle=`rgba(255,255,255,${t.a})`,ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(n,a),ctx.stroke(),t.x+=t.vx,t.y+=t.vy,t.a-=.02,(t.a<=0||t.x>w+200||t.y>h+200)&&meteors.splice(e,1)}ctx.strokeStyle="#fff",ctx.lineWidth=1}function loop(){drawStars(),drawMeteors(),(isLowEnd?.005:.01)>Math.random()&&createMeteor(),animationId=requestAnimationFrame(loop)}window.addEventListener("resize",resizeCanvas),resizeCanvas(),loop();const lanternContainer=document.getElementById("lantern-container"),wishes=["Ch\xfac cậu Trung Thu ấm \xe1p v\xe0 tr\xe0n đầy niềm vui!","Ch\xfac cậu Trung thu an l\xe0nh, hạnh ph\xfac, ng\xe0y c\xe0ng xinh đẹp như chị Hằng nh\xe9!","Mong cậu lu\xf4n s\xe1ng như trăng, ngọt như b\xe1nh nướng!","Trung Thu vui vẻ, ngập tr\xe0n tiếng cười!","Ch\xfac cậu mọi điều tốt đẹp v\xe0 may mắn!","Ch\xfac mừng Tết Trung thu, mong vầng trăng tr\xf2n sẽ mang tới hạnh ph\xfac v\xe0 th\xe0nh c\xf4ng cho gia đ\xecnh bạn!",],wishImages=["images/wish1.webp","images/wish2.jpg","images/wish3.png","images/wish4.png","images/wish5.png"],lanternImages=["den.png","den1.png","den2.png"];function createLantern(){let e=document.createElement("img"),t=lanternImages[Math.floor(Math.random()*lanternImages.length)];e.src=t,e.className="lantern swing";let n=Math.floor(3*Math.random())+1,a=40,o=1e4,r=.8;1===n?(a=20+20*Math.random(),o=14e3+5e3*Math.random(),r=.5):2===n?(a=30+30*Math.random(),o=12e3+4e3*Math.random(),r=.7):(a=40+40*Math.random(),o=1e4+3e3*Math.random(),r=.95),e.style.width=a+"px",e.style.left=100*Math.random()+"vw",e.style.bottom="0px",e.style.opacity=r;let $=.4+.4*Math.random(),i=15+20*Math.random(),s=Math.random()>.5?`rgba(255, ${200+55*Math.random()}, 0, ${$})`:`rgba(255, ${150+50*Math.random()}, ${50+50*Math.random()}, ${$})`;e.style.filter=isLowEnd?"none":isHighEnd?`drop-shadow(0 0 ${i}px ${s}) drop-shadow(0 0 ${i*1.5}px ${s.replace(/[\d.]+\)$/,"0.3)")}) drop-shadow(0 0 ${i*2}px ${s.replace(/[\d.]+\)$/,"0.2)")})`:`drop-shadow(0 0 ${i}px ${s})`,lanternContainer.appendChild(e);let l=Math.random()>.5?1:-1;e.animate([{transform:"translate(0,0) rotate(0deg)",opacity:r},{transform:`translate(${l*(200+300*Math.random())}px, -${150+60*Math.random()}vh) rotate(${l*(30+40*Math.random())}deg)`,opacity:0}],{duration:o,easing:"linear",fill:"forwards"}),setTimeout(()=>e.remove(),o),e.addEventListener("mouseenter",e=>{e.target.style.animationPlayState="paused",e.target.style.animation="lanternHover 0.6s ease-in-out infinite alternate"}),e.addEventListener("mouseleave",e=>{e.target.style.animation="swing 2s ease-in-out infinite"}),e.addEventListener("click",e=>{e.stopPropagation();let t=document.getElementById("wish-popup"),n=document.getElementById("wish-text"),a=document.getElementById("wish-img"),o=wishes[Math.floor(Math.random()*wishes.length)],r=wishImages[Math.floor(Math.random()*wishImages.length)];n.textContent=o,a.src=r,t.style.display="block"})}let lastLanternTime=0;const LANTERN_INTERVAL=isLowEnd?1200:isMobile?(isPortrait?600:800):isTablet?(isLandscape?500:700):isHighEnd?400:500;function createLanternThrottled(){let e=Date.now();e-lastLanternTime>=LANTERN_INTERVAL&&(createLantern(),lastLanternTime=e)}setInterval(createLanternThrottled,LANTERN_INTERVAL);for(let i=0;i<3;i++)setTimeout(()=>createLantern(),i*1000);const moon=document.querySelector(".moon");moon&&(moon.addEventListener("mouseenter",()=>{moon.style.animation="moonHover 0.5s ease-in-out infinite alternate"}),moon.addEventListener("mouseleave",()=>{moon.style.animation="moonGlow 6s ease-in-out infinite"}));const bg=document.getElementById("bg-music"),hint=document.getElementById("hint");let musicStarted=!1;document.addEventListener("pointerdown",function e(){!musicStarted&&bg&&(bg.volume=0,bg.play().then(()=>{let e=0,t=setInterval(()=>{(e+=.05)>=.9&&(e=.9,clearInterval(t)),bg.volume=e},120);musicStarted=!0}).catch(e=>{console.warn("Kh\xf4ng thể ph\xe1t nhạc:",e),musicStarted=!0})),document.removeEventListener("pointerdown",e)}),document.addEventListener("click",()=>{let e=document.getElementById("wish-popup");e&&"block"===e.style.display&&(e.style.display="none")}),setTimeout(()=>{hint&&(hint.style.opacity="1"),setTimeout(()=>{hint&&(hint.style.opacity="0")},5e3)},1e3);