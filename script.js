const canvas=document.getElementById("starfield"),ctx=canvas.getContext("2d");let w,h,stars=[],meteors=[],animationId;const TWINKLE_SPEED=.003,METEOR_CHANCE=.01;const isMobile=window.innerWidth<=768,isTablet=window.innerWidth<=1024&&window.innerWidth>768,isLowEnd=navigator.hardwareConcurrency<=2||navigator.deviceMemory<=4,isHighEnd=navigator.hardwareConcurrency>=6&&navigator.deviceMemory>=8,aspectRatio=window.innerWidth/window.innerHeight,isPortrait=aspectRatio<1,isLandscape=aspectRatio>1.3,isSquare=aspectRatio>=0.9&&aspectRatio<=1.3;function resizeCanvas(){w=canvas.width=innerWidth,h=canvas.height=innerHeight,stars=[];let e=Math.round(w*h/(isLowEnd?4000:isMobile?(isPortrait?2500:3000):isTablet?(isLandscape?2000:2500):isHighEnd?1800:2200));for(let t=0;t<e;t++)stars.push({x:Math.random()*w,y:Math.random()*h,r:.9*Math.random()+.1,a:.8*Math.random()+.2,t:.02*Math.random()+.002})}function drawStars(){for(let e of(ctx.clearRect(0,0,w,h),stars)){e.a+=(Math.random()>.5?1:-1)*e.t,e.a=Math.max(.05,Math.min(1,e.a));let t=isLowEnd?.5:isHighEnd?.3*Math.sin(.003*Date.now()+.01*e.x)+.7:.4*Math.sin(.003*Date.now()+.01*e.x)+.6,n=e.a*t;ctx.beginPath(),ctx.globalAlpha=n;if(isHighEnd||!isLowEnd){let a=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,2*e.r);a.addColorStop(0,"#ffffff"),a.addColorStop(.5,"#ffd700"),a.addColorStop(1,"rgba(255, 255, 255, 0)"),ctx.fillStyle=a}else ctx.fillStyle="#ffffff";ctx.arc(e.x,e.y,e.r,0,2*Math.PI),ctx.fill(),isLowEnd||.1>Math.random()||(ctx.strokeStyle=`rgba(255, 255, 255, ${.5*n})`,ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(e.x-3*e.r,e.y),ctx.lineTo(e.x+3*e.r,e.y),ctx.moveTo(e.x,e.y-3*e.r),ctx.lineTo(e.x,e.y+3*e.r),ctx.stroke())}ctx.globalAlpha=1}function createMeteor(){let e=Math.random()*w,t=Math.random()*(h/3),n=10*Math.random()+6,o=120*Math.random()+100;meteors.push({x:e,y:t,vx:n+6,vy:n/2,len:o,a:1,color:Math.random()>.5?"#ffffff":"#ffd700",glow:Math.random()>.7,particles:[],headSize:8+Math.random()*4,starburst:Math.random()>.5})}function drawMeteors(){for(let e=meteors.length-1;e>=0;e--){let t=meteors[e],n=t.x-t.len,a=t.y-t.len/2;ctx.save(),ctx.globalAlpha=t.a;if((isHighEnd||!isLowEnd)&&t.glow){let o=ctx.createLinearGradient(t.x,t.y,n,a);o.addColorStop(0,`${t.color}ff`),o.addColorStop(.1,`${t.color}f0`),o.addColorStop(.25,`${t.color}d0`),o.addColorStop(.5,`${t.color}a0`),o.addColorStop(.75,`${t.color}60`),o.addColorStop(.9,`${t.color}20`),o.addColorStop(1,`${t.color}00`),ctx.strokeStyle=o,ctx.lineWidth=isLowEnd?3:6,ctx.shadowColor=t.color,ctx.shadowBlur=isLowEnd?8:20;let r=ctx.createLinearGradient(t.x,t.y,n,a);r.addColorStop(0,`${t.color}80`),r.addColorStop(.3,`${t.color}40`),r.addColorStop(.7,`${t.color}20`),r.addColorStop(1,`${t.color}00`),ctx.strokeStyle=r,ctx.lineWidth=isLowEnd?1:2,ctx.shadowBlur=0,ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(n,a),ctx.stroke(),ctx.strokeStyle=o,ctx.lineWidth=isLowEnd?3:6,ctx.shadowColor=t.color,ctx.shadowBlur=isLowEnd?8:20}else{ctx.strokeStyle=`${t.color}${Math.floor(255*t.a).toString(16).padStart(2,"0")}`,ctx.lineWidth=isLowEnd?2:3,ctx.shadowBlur=0}ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(n,a),ctx.stroke();if(!isLowEnd){let o=t.headSize*t.a;if(t.starburst){ctx.strokeStyle=`${t.color}${Math.floor(255*t.a).toString(16).padStart(2,"0")}`,ctx.lineWidth=1,ctx.shadowColor=t.color,ctx.shadowBlur=3;for(let r=0;r<8;r++){let i=Math.PI*r/4;ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(t.x+Math.cos(i)*o,t.y+Math.sin(i)*o),ctx.stroke()}ctx.beginPath(),ctx.arc(t.x,t.y,o/3,0,2*Math.PI),ctx.fillStyle=`${t.color}${Math.floor(255*t.a*.8).toString(16).padStart(2,"0")}`,ctx.fill()}let s=ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,o);s.addColorStop(0,`${t.color}${Math.floor(255*t.a).toString(16).padStart(2,"0")}`),s.addColorStop(.3,`${t.color}${Math.floor(255*t.a*.6).toString(16).padStart(2,"0")}`),s.addColorStop(1,`${t.color}00`),ctx.fillStyle=s,ctx.beginPath(),ctx.arc(t.x,t.y,o,0,2*Math.PI),ctx.fill();if(t.particles.length<25&&Math.random()>.6){t.particles.push({x:t.x+Math.random()*30-15,y:t.y+Math.random()*30-15,vx:Math.random()*6-3,vy:Math.random()*6-3,life:1,size:Math.random()*3+1,angle:Math.random()*Math.PI*2})}for(let r=t.particles.length-1;r>=0;r--){let i=t.particles[r];i.x+=i.vx,i.y+=i.vy,i.life-=.015;if(i.life<=0){t.particles.splice(r,1);continue}ctx.globalAlpha=i.life*t.a;let u=ctx.createRadialGradient(i.x,i.y,0,i.x,i.y,i.size*2);u.addColorStop(0,`${t.color}${Math.floor(255*i.life*t.a).toString(16).padStart(2,"0")}`),u.addColorStop(.5,`${t.color}${Math.floor(255*i.life*t.a*.5).toString(16).padStart(2,"0")}`),u.addColorStop(1,`${t.color}00`),ctx.fillStyle=u,ctx.beginPath(),ctx.arc(i.x,i.y,i.size,0,2*Math.PI),ctx.fill()}}ctx.restore(),t.x+=t.vx,t.y+=t.vy,t.a-=.01,(t.a<=0||t.x>w+200||t.y>h+200)&&meteors.splice(e,1)}ctx.strokeStyle="#fff",ctx.lineWidth=1,ctx.shadowBlur=0}function loop(){drawStars(),drawMeteors(),(isLowEnd?.015:isMobile?.025:.03)>Math.random()&&createMeteor(),animationId=requestAnimationFrame(loop)}window.addEventListener("resize",resizeCanvas),resizeCanvas(),loop();const lanternContainer=document.getElementById("lantern-container"),wishes=["Ch\xfac cậu Trung Thu ấm \xe1p v\xe0 tr\xe0n đầy niềm vui!","Ch\xfac cậu Trung thu an l\xe0nh, hạnh ph\xfac, ng\xe0y c\xe0ng xinh đẹp như chị Hằng nh\xe9!","Mong cậu lu\xf4n s\xe1ng như trăng, ngọt như b\xe1nh nướng!","Trung Thu vui vẻ, ngập tr\xe0n tiếng cười!","Ch\xfac cậu mọi điều tốt đẹp v\xe0 may mắn!","Ch\xfac mừng Tết Trung thu, mong vầng trăng tr\xf2n sẽ mang tới hạnh ph\xfac v\xe0 th\xe0nh c\xf4ng cho gia đ\xecnh bạn!",],wishImages=["images/wish1.webp","images/wish2.jpg","images/wish3.png","images/wish4.png","images/wish5.png"],lanternImages=["den.png","den1.png","den2.png"];function createLantern(){let e=document.createElement("img"),t=lanternImages[Math.floor(Math.random()*lanternImages.length)];e.src=t,e.className="lantern swing";let n=Math.floor(3*Math.random())+1,a=50,o=1e4,r=.8;1===n?(a=25+25*Math.random(),o=22e3+8e3*Math.random(),r=.5):2===n?(a=35+35*Math.random(),o=20e3+7e3*Math.random(),r=.7):(a=50+50*Math.random(),o=18e3+6e3*Math.random(),r=.95),e.style.width=a+"px",e.style.left=100*Math.random()+"vw",e.style.bottom="0px",e.style.opacity=r;let $=.4+.4*Math.random(),i=15+20*Math.random(),s=Math.random()>.5?`rgba(255, ${200+55*Math.random()}, 0, ${$})`:`rgba(255, ${150+50*Math.random()}, ${50+50*Math.random()}, ${$})`;e.style.filter=isLowEnd?"none":isHighEnd?`drop-shadow(0 0 ${i}px ${s}) drop-shadow(0 0 ${i*1.5}px ${s.replace(/[\d.]+\)$/,"0.3)")}) drop-shadow(0 0 ${i*2}px ${s.replace(/[\d.]+\)$/,"0.2)")})`:`drop-shadow(0 0 ${i}px ${s}) drop-shadow(0 0 ${i*1.2}px ${s.replace(/[\d.]+\)$/,"0.4)")})`,lanternContainer.appendChild(e);let l=Math.random()>.5?1:-1;e.animate([{transform:"translate(0,0) rotate(0deg)",opacity:r},{transform:`translate(${l*(250+350*Math.random())}px, -${180+80*Math.random()}vh) rotate(${l*(40+50*Math.random())}deg)`,opacity:0}],{duration:o,easing:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",fill:"forwards"}),setTimeout(()=>e.remove(),o),e.addEventListener("mouseenter",e=>{e.target.style.animationPlayState="paused",e.target.style.animation="lanternHover 0.6s ease-in-out infinite alternate"}),e.addEventListener("mouseleave",e=>{e.target.style.animation="swing 2s ease-in-out infinite"}),e.addEventListener("click",e=>{e.stopPropagation();let t=document.getElementById("wish-popup"),n=document.getElementById("wish-text"),a=document.getElementById("wish-img"),o=wishes[Math.floor(Math.random()*wishes.length)],r=wishImages[Math.floor(Math.random()*wishImages.length)];n.textContent=o,a.src=r,t.style.display="block"})}let lastLanternTime=0;const LANTERN_INTERVAL=isLowEnd?800:isMobile?(isPortrait?300:400):isTablet?(isLandscape?300:500):isHighEnd?250:350;function createLanternThrottled(){let e=Date.now();e-lastLanternTime>=LANTERN_INTERVAL&&(createLantern(),lastLanternTime=e)}setInterval(createLanternThrottled,LANTERN_INTERVAL);for(let i=0;i<3;i++)setTimeout(()=>createLantern(),i*1000);const moon=document.querySelector(".moon");moon&&(moon.addEventListener("mouseenter",()=>{moon.style.animation="moonHover 0.5s ease-in-out infinite alternate"}),moon.addEventListener("mouseleave",()=>{moon.style.animation="moonGlow 6s ease-in-out infinite"}));const bg=document.getElementById("bg-music"),hint=document.getElementById("hint");let musicStarted=!1;document.addEventListener("pointerdown",function e(){!musicStarted&&bg&&(bg.volume=0,bg.play().then(()=>{let e=0,t=setInterval(()=>{(e+=.05)>=.9&&(e=.9,clearInterval(t)),bg.volume=e},120);musicStarted=!0}).catch(e=>{console.warn("Kh\xf4ng thể ph\xe1t nhạc:",e),musicStarted=!0})),document.removeEventListener("pointerdown",e)}),document.addEventListener("click",()=>{let e=document.getElementById("wish-popup");e&&"block"===e.style.display&&(e.style.display="none")}),setTimeout(()=>{hint&&(hint.style.opacity="1"),setTimeout(()=>{hint&&(hint.style.opacity="0")},5e3)},1e3);